#!/bin/bash

# spawn jobs to extract function args

# parse the bounce is data file name to extract parts for nameing results
biofn=$1
biodate=`echo $biofn |  awk -F__ '{print $2}' | awk -F. '{print $1}'`

datestamp=`echo $biodate | awk -F_ '{print $1}'`
timestamp=`echo $biodate | awk -F_ '{print $2}' | sed -e 's/-/:/g'`

datestring="$datestamp $timestamp"
year=`date --date="$datestring" "+%Y"`
month=`date --date="$datestring" "+%m"`
day=`date --date="$datestring" "+%d"`

mkdir -p data/funargs/$year/$month/$day

funargsfn=funargs__$biodate

cat << EOF
#!/bin/bash

#$ -S /bin/bash
#$ -cwd
#$ -N fa_$biodate
#$ -l h_rt=00:30:00,vf=1G
#$ -M jpr
#$ -m eas
#
echo DEBUG bash opts
echo $-
echo DEBUG list alias
alias
echo DEBUG which python
which python
echo DEBUG list env
env | sort 
echo DEBUG list exports
export -p
echo DEBUG list functions
declare -f

echo DEBUG redefine which as function
which ()
    {
       (alias; declare -f) | /usr/bin/which --tty-only --read-alias --read-functions --show-tilde --show-dot $@
    }
export -f which
echo DEBUG list functions
declare -f


#unset module
#module use `pwd` 
echo DEBUG add minemail to modules
module use /rstore/user/jpr/default/projects/minemail
#module load python/python-2.7
#module load minemail

echo DEBUG modulecmd load python/python-2.7 minemail
/usr/bin/modulecmd bash load python/python-2.7 minemail 2>&1

echo DEBUG module load
module load python/python-2.7 minemail

echo DEBUG list alias
alias
echo DEBUG which python
which python
echo DEBUG list env
env | sort
echo DEBUG list exports
export -p
echo DEBUG list functions
declare -f 

echo DEBUG call modulecmd
/usr/bin/modulecmd bash load python/python-2.7 2>&1
echo

echo DEBUG show modulecmd
/usr/bin/modulecmd bash show python/python-2.7 2>&1

#echo DEBUG python func workaround
#python() { /share/apps/python/2.7.2/bin/python2.7;}
#export -f python

echo DEBUG list functions
export -f 

echo DEBUG which python
which python
echo DEBUG which python2.7
which python2.7

head $biofn | bash -x geturi | python -v bin/funargs_itemset > data/funargs/$year/$month/$day/$funargsfn

sleep 100
EOF

